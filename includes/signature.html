<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Documentation</title>

    <link href="../stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="../javascripts/all_nosearch.js" type="text/javascript"></script>

  </head>

  <body class="includes includes_signature">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="../images/logo.png" />
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="签名方法">签名方法</h1>

<p>这里介绍API请求中签名 ( signature ) 的生成方法。签名需要你先在控制台创建 API密钥 ，获得 accesss_key_id 和 secret_access_key.</p>

<blockquote>
<p>这里我们假设</p>
</blockquote>
<pre class="highlight shell"><code>access_key_id <span class="o">=</span> <span class="s1">'NOVADATAACCESSKEYIDEXAMPLE'</span>
secret_access_key <span class="o">=</span> <span class="s1">'SECRETACCESSKEY'</span>
</code></pre>

<blockquote>
<p>例如我们的请求参数如下:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"limit"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="s2">"offset"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fields"</span><span class="p">:</span><span class="s2">"data.*"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"sort"</span><span class="p">:</span><span class="s2">"price:desc"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"signature_version"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"access_key_id"</span><span class="p">:</span><span class="s2">"NOVADATAACCESSKEYIDEXAMPLE"</span><span class="p">,</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></pre>

<blockquote>
<p>注解 你可以使用上述的 AccessKey 和 Request 调试你的代码， 当得到跟后面一致的签名结果后(即表示你的代码是正确的)， 可再换为你自己的 AccessKey 和其他 API 请求。</p>
</blockquote>

<h2 id="1.按参数名进行升序排列">1.按参数名进行升序排列</h2>

<blockquote>
<p>排序后的参数为:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"access_key_id"</span><span class="p">:</span><span class="s2">"NOVADATAACCESSKEYIDEXAMPLE"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fields"</span><span class="p">:</span><span class="s2">"data.*"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"limit"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="s2">"offset"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="s2">"signature_version"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"sort"</span><span class="p">:</span><span class="s2">"price:desc"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<h2 id="2.对参数名称和参数值进行url编码">2.对参数名称和参数值进行URL编码</h2>

<blockquote>
<p>编码后的请求串为:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"access_key_id"</span><span class="p">:</span><span class="s2">"NOVADATAACCESSKEYIDEXAMPLE"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"fields"</span><span class="p">:</span><span class="s2">"data.*"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"limit"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="s2">"offset"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="s2">"signature_version"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="s2">"sort"</span><span class="p">:</span><span class="s2">"price%3Adesc"</span><span class="p">,</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></pre>

<h2 id="3.构造url请求">3.构造URL请求</h2>

<p>参数名和参数值之间用”=”号连接，参数和参数之间用”＆”号连接，构造后的URL请求为</p>
<pre class="highlight plaintext"><code>access_key_id=NOVADATAACCESSKEYIDEXAMPLE&amp;fields=data.*&amp;limit=2&amp;offset=10&amp;signature_version=1&amp;sort=price%3Adesc
</code></pre>

<h2 id="4.构造被签名串">4.构造被签名串</h2>

<p>被签名串的构造规则为: 被签名串 = HTTP请求方式 + &ldquo;\n&rdquo; + uri + &ldquo;\n&rdquo; + url 请求串</p>

<blockquote>
<p>注解 &ldquo;\n&rdquo; 是换行符，不要将 &ldquo;\&rdquo; 转义。也就是说，不要用 &ldquo;\n&rdquo; ，有些语言，比如php和ruby，请用 &ldquo;\n&rdquo; , 而不是 &rsquo;\n&rsquo;</p>

<p>假设 HTTP 请求方法为 GET, 请求的uri路径为 &ldquo;/v1/data/websites/1&rdquo;, 则被签名串为</p>
</blockquote>
<pre class="highlight plaintext"><code>GET\n/v1/data/websites/1\naccess_key_id=NOVADATAACCESSKEYIDEXAMPLE&amp;fields=data.*&amp;limit=2&amp;offset=10&amp;signature_version=1&amp;sort=price%3Adesc
</code></pre>

<h2 id="5.计算签名">5.计算签名</h2>

<blockquote>
<p>以 Python 代码为例 (其他语言类似，需要使用 sha256 + base64 编码，最后需要再进行 URL 编码，URL 编码时需要将原有的空格 ” ” 转为 “+”)</p>
</blockquote>
<pre class="highlight python"><code><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret_access_key</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">sha256</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">"string_to_sign"</span><span class="p">)</span> <span class="c"># 前面生成的被签名串</span>
<span class="n">sign</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Java计算SHA256哈希。Base64编码可以使用apache commons codec,<a href="https://gist.github.com/fivesmallq/9482ca783578f1356243">完整示例代码</a></p>
</blockquote>
<pre class="highlight java"><code>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">calculateSignature</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">stringToSign</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">ENCODING</span> <span class="o">=</span> <span class="s">"UTF-8"</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s">"HmacSHA256"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">signData</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Mac</span> <span class="n">mac</span> <span class="o">=</span> <span class="n">Mac</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ALGORITHM</span><span class="o">);</span>
            <span class="n">mac</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">ENCODING</span><span class="o">),</span> <span class="n">ALGORITHM</span><span class="o">));</span>
            <span class="n">signData</span> <span class="o">=</span> <span class="n">mac</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">stringToSign</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">ENCODING</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvalidKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalStateException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">encodeBase64</span><span class="o">(</span><span class="n">signData</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre>

<ul>
<li>将API密钥的私钥 ( secret_access_key ) 作为key，生成被签名串的 HMAC-SHA256 签名，更多信息可参见 <a href="http://www.ietf.org/rfc/rfc2104.txt">RFC2104</a></li>
<li>将签名进行 Base64 编码</li>
<li>将 Base64 编码后的结果进行 URL 编码 （注意，当 Base64 编码后存在空格时，不要对空格进行 URL 编码，而要直接将空格转为”+”）</li>
<li>将签名用于参数”signature”的值。</li>
</ul>

<h2 id="6.添加签名">6.添加签名</h2>

<p>将签名参数附在原有请求串的最后面。最终的HTTP请求串为(为了查看方便，我们人为地将参数之间用回车分隔开)</p>
<pre class="highlight plaintext"><code>access_key_id=NOVADATAACCESSKEYIDEXAMPLE
&amp;fields=data.*
&amp;limit=2
&amp;offset=10
&amp;signature_version=1
&amp;sort=price%3Adesc
&amp;signature=B9willCeoxK2KJLoZNn%2BOXl%2FiXE3Mu815P6y3KLn3CE%3D
</code></pre>

<blockquote>
<p>完整的请求URL为(为了查看方便，我们人为地将参数之间用回车分隔开)</p>
</blockquote>
<pre class="highlight plaintext"><code>https://api.novadata.cn/v1/data/website/1?access_key_id=NOVADATAACCESSKEYIDEXAMPLE
&amp;fields=data.*
&amp;limit=2
&amp;offset=10
&amp;signature_version=1
&amp;sort=price%3Adesc
&amp;signature=B9willCeoxK2KJLoZNn%2BOXl%2FiXE3Mu815P6y3KLn3CE%3D
</code></pre>

<blockquote>
<p>实际URL为</p>
</blockquote>
<pre class="highlight plaintext"><code>https://api.novadata.cn/v1/data/website/1?access_key_id=NOVADATAACCESSKEYIDEXAMPLE&amp;fields=data.*&amp;limit=2&amp;offset=10&amp;signature_version=1&amp;sort=price%3Adesc&amp;signature=B9willCeoxK2KJLoZNn%2BOXl%2FiXE3Mu815P6y3KLn3CE%3D
</code></pre>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
